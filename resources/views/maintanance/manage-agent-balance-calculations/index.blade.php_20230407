@extends('layouts.app')
@section('title','Manage Agent Balance Calculations')
@section('css')
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 17px !important;
    }
</style>
@endsection

@section('contents')
<div class="col-12 grid-margin">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h4 class="card-title text-uppercase">Manage Agent Balance Calculations</h4>
                    <p class="card-description">List of balance calculations for selected agents.</p>
                </div>
            </div>
            <form action="">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select required name="agent_id" id="agent-select2" class="form-control   form-control-sm select2">
                            @if($agent)
                            <option value="{{$agent->id}}" selected>{{$agent->code .' '. $agent->company_name . ' ' . $agent->phone . ' BL '. $agent->opening_balance. ' CB ' . $agent->credit_balance}}</option>
                            @endif
                            <option value="">Select Agent</option>

                        </select>
                    </div>

                    <div class="col-md-2">
                        <select required name="fys_id" id="fys_id" class="form-control   form-control-sm select2">

                            @foreach ($financial_year as $key => $val)
                            <option value="{{ $val->id }}" @if ($val->id == request()->query('fys_id')) selected @elseif ($val->isActive == 1) selected @endif>{{ $val->name }}

                            </option>
                            @endforeach
                        </select>
                    </div>

                    <div class="col-md-2">
                        <input type="text" class="form-control form-control-sm datepicker" placeholder="Start Date" name="start_date" id="start_date" autocomplete="off" value="{{ request()->query('start_date') }}">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control  form-control-sm  datepicker" placeholder="End Date" name="end_date" id="end_date" autocomplete="off" value="{{ request()->query('end_date') }}">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-primary btn-sm" name="searchBtn">Search</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="table-responsive-lg">
            <table id="sortable-table-2" class="table table-bordered table-sm text-left ">
                <thead class="thead-dark">
                    <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Order Type</th>
                        <th>Ref. No</th>
                        <th>Sector</th>
                        <th>Travel Date</th>
                        <th>Airline</th>
                        <th>PNR</th>
                        <th>No Of Pax</th>
                        <th>Pax Name</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Balance</th>
                        <th>Desc</th>
                    </tr>
                </thead>
                <tbody>
                    @if (count($data['BalanceCalculations']) > 0)
                    @foreach ($data['BalanceCalculations'] as $k => $v)
                    @foreach ($v as $key=>$value )
                    <tr>
                        <td>{{ $key + 1 }}</td>
                        <td>{{ $value->CreatedDate }}</td>
                        <td>{{ $value->OrderType }}</td>
                        @if ($value->Type == 1)
                        <td class="text-center">{{ $value->reference_no }}</td>
                        <td colspan="6" class="text-center  font-weight-bold text-success">Temp Credit ( {{ $value->amount }} )</td>
                        @elseif($value->Type == 5)
                        <td class="text-center   ">{{ $value->reference_no }}</td>
                        <td colspan="6" class="text-center  font-weight-bold text-warning">Temp Debit ( {{ $value->amount }} )</td>
                        @elseif($value->Type == 7)
                        <td class="text-center">{{ $value->reference_no }} </td>
                        <td colspan="6" class="text-center  font-weight-bold text-success">Distributor Balance ( {{ $value->amount }} )</td>
                        @elseif($value->Type == 3)
                        <td class="text-center">RCPT-{{ $value->id }} </td>
                        <td colspan="6"> </td>
                        @elseif($value->Type == 8)
                        <td colspan="7"></td>
                        @elseif($value->Type == 2 || $value->Type == 4 || $value->Type == 6)
                        <td>{{ $value->RefNo }}</td>
                        <td>{{ $value->Sector }}</td>
                        <td>{{ $value->TravelDate }}</td>
                        <td>{{ $value->Airline }}</td>
                        <td>{{ $value->PNR }}</td>
                        <td class="text-center">
                            @if($value->Type == 4)
                            {{ $value->refund }}
                            @else
                            {{ $value->NoOfPax }}
                            @endif
                        </td>
                        <td class="text-center">{{ $value->PaxName }}
                        <td>{{ $value->Debit }}</td>
                        <td>{{ $value->Credit }}</td>
                        <td>{{ $value->ClosingBalance }}
                        <td>{{ $value->Remarks }}</td>
                        </td>
                    </tr>
                    @endif
                    @endforeach
                    @endforeach

                    @else
                    <tr>
                        <th colspan="12" class="text-center">No Result Found</th>
                    </tr>
                    @endif
                    </td>
                </tbody>
                <tfoot>
                </tfoot>
            </table>
        </div>

    </div>
</div>

@endsection
@section('js')
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        let start_date = $('#start_date').val();
        let end_date = $('#end_date').val();
        if (!start_date && !end_date) {
            let today = new Date();
            let date1 = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            $('#end_date').val(date1);

            let today1 = new Date()
            let days = 86400000
            let sevenDaysAgo = new Date(today1 - (30 * days))
            let date2 = sevenDaysAgo.getFullYear() + '-' + (sevenDaysAgo.getMonth() + 1) + '-' + sevenDaysAgo.getDate();
            $('#start_date').val(date2);
        }

        $(".datepicker").datepicker({
            todayHighlight: true,
            autoclose: true,
            format: 'yyyy-mm-dd'
        });

        $('#start_date').change(function() {
            let start_date = $('#start_date').val();
            let start_date_year = start_date.split('-')[0];
            let start_date_month = start_date.split('-')[1];
            let start_date_day = start_date.split('-')[2];

            let endDate = $('#end_date');
            endDate.datepicker('destroy');
            endDate.datepicker({
                format: 'yyyy-mm-dd',
                startDate: new Date(start_date_year + '-' + start_date_month + '-' + start_date_day)
            });
            endDate.val(start_date);
            //endDate.attr("required", "true");
        })

        $("#agent-select2").select2({
            allowClear: false,
            ajax: {
                url: '/flight-tickets/ajax/search/agents',
                delay: 250,
                data: function(params) {
                    var query = {
                        q: params.term,
                    }
                    return query;
                },
                processResults: function(data) {
                    return {
                        results: data
                    };
                },

                dataType: 'json',
                cache: true
            },
            minimumInputLength: 4,
        });
    });
</script>
@endsection